package main

import (
	"fmt"
	"strconv"
	"strings"
)

func main() {
	fmt.Println(solve(parse(example), 0+0i, 1+0i)) // 46
	fmt.Println(solve(parse(input), 0+0i, 1+0i))   // 8323
	fmt.Println(part2(parse(example)))             // 51
	fmt.Println(part2(parse(input)))               // 8491
}

type Point struct {
	x, y int
}

func part2(m map[Point]rune) int {
	var maxX, maxY int
	for p := range m {
		maxX = max(maxX, p.x)
		maxY = max(maxX, p.y)
	}

	var tiles int
	for x := 0; x <= maxX; x++ {
		// From top, heading downward
		a := solve(m, complex(float64(x), 0), 0+1i)
		// From bottom, heading upward
		b := solve(m, complex(float64(x), float64(maxY)), 0-1i)
		tiles = max(tiles, max(a, b))
	}

	for y := 0; y <= maxY; y++ {
		// From left, heading rightward
		c := solve(m, complex(0, float64(y)), 1+0i)
		// From right, heading leftward
		d := solve(m, complex(float64(maxX), float64(y)), -1+0i)
		tiles = max(tiles, max(c, d))
	}
	return tiles
}

func solve(m map[Point]rune, start, dir complex128) int {
	// Records the mirror location,
	// the input and output directions.
	reflection := make(map[complex128]map[complex128]string)
	for v, r := range m {
		p := complex(float64(v.x), float64(v.y))
		isMirror := r != '.'
		if isMirror {
			up := 0 - 1i
			down := 0 + 1i
			left := -1 + 0i
			right := 1 + 0i

			reflection[p] = make(map[complex128]string)

			// -: move straight
			// c: clockwise
			// a: anti-clockwise
			switch r {
			case '|':
				reflection[p][up] = "-"
				reflection[p][down] = "-"
				reflection[p][left] = "ca"
				reflection[p][right] = "ca"
			case '-':
				reflection[p][up] = "ca"
				reflection[p][down] = "ca"
				reflection[p][left] = "-"
				reflection[p][right] = "-"
			case '\\':
				reflection[p][up] = "a"
				reflection[p][down] = "a"
				reflection[p][left] = "c"
				reflection[p][right] = "c"
			case '/':
				reflection[p][up] = "c"
				reflection[p][down] = "c"
				reflection[p][left] = "a"
				reflection[p][right] = "a"
			}
		}
	}
	var queue []Tuple[complex128]
	queue = append(queue, Tuple[complex128]{start, dir})

	seen := make(map[Tuple[complex128]]bool)

	for len(queue) > 0 {
		var head Tuple[complex128]
		head, queue = queue[0], queue[1:]

		vec, dir := head.a, head.b

		// Out of bound.
		p := Point{int(real(vec)), int(imag(vec))}
		if _, ok := m[p]; !ok {
			continue
		}

		if seen[head] {
			continue
		}
		seen[head] = true

		// On a mirror?
		if v, ok := reflection[vec]; ok {
			dirs := v[dir]
			for _, d := range dirs {
				newdir := dir
				switch d {
				case 'a':
					newdir *= -1i
				case 'c':
					newdir *= 1i
				}

				queue = append(queue, Tuple[complex128]{vec + newdir, newdir})
			}
		} else {
			queue = append(queue, Tuple[complex128]{vec + dir, dir})
		}
	}

	unique := make(map[complex128]bool)
	for v := range seen {
		unique[v.a] = true
	}

	return len(unique)
}

type Tuple[T any] struct {
	a, b T
}

func parse(in string) map[Point]rune {
	res := make(map[Point]rune)
	lines := strings.Split(in, "\n")
	for y, line := range lines {
		for x, r := range line {
			res[Point{x, y}] = r
		}
	}

	return res
}

func toInt(s string) int {
	n, err := strconv.Atoi(s)
	if err != nil {
		panic(err)
	}

	return n
}

var example = `.|...\....
|.-.\.....
.....|-...
........|.
..........
.........\
..../.\\..
.-.-/..|..
.|....-|.\
..//.|....`
var input = `\.........../..\..../.../......./.....\.................-..............-......./..-................./.\|......
../..|..\..\...........\..........-..|.|...........................|...../..............-.................-../
.|..\................../...........................|..............|...-.................././........./........
......./....\.|................\\....|...\......................../\......|......../..........-........./.....
........................-......................|...\.............-..|..|..........|...........................
.............../-............\....\...............-......\..-.............\./...........|.....................
........./|.|...........................-.........................-.-.......\.........-.......\/....|.........
............-.-.........\........../........|..........||............./.-.....................................
................||.....|................-........\............./.................-....../......|..........\...
........................../\..|.......|........|.|..../../.../.....-.-..-..-..........................\.......
..-.......\..............|.|...........|............./....-...........|......-.......|...........|.|....\.....
.\./.\.....-.................................|.......-|...\..........\.........-./......./...................\
....|.................|..............|..|.\............\\...\......\..................-..................\../|
..........|.....\..............................|.-.\................-................./|............../.......
..\|......./............-...............|...|...-..|................../..../.|.........\..........-.........\.
.|\............../............-/.........\.......\.........../........................./......................
...\..................................................\...|...............\..............\....................
..|........./..........|..........................././..............................................\\.|......
...........-.-..............\..-............-..................|/|..............|..-...../.|................\.
..........|..|.../...........................|....-....../........................-.........|.................
\.....................\............/...........-....................../.\...........-..../..........\.........
........-................\\\.........|/....../\..|..|.-...-..............\.....|..............-.........-.....
..........-........-....|.................-.........................\\...-...\|..|.............../.....\.|....
.............................................................|........\-................-....................\
/......\....|-............./...........|................/...\.........|.....-.............|/...|..|...../.....
|...-.........-....................................././|..\...\..../.......|.......\................../.......
...........-..-........../........................\\...................................\......................
............\.......\\|.|.......-.............|..../........-.....|....|.../.-............./.-........../...|.
...................................-..............\...\....\...|..........|.................../..../.......|..
...-...............|......\|/...............-./..../........................\......../.....................|..
.........................................|....\.\..............\-...\\........\.../...........././............
......|........./.|./.................-...../..--.......|...............-.\......|...................|........
.....-.-..............|............../...................\/......./.....|............|....-...................
...-./..........-..........\...../.......-................./........-............................\....\.......
\.../.....|....................\|...........................\.......\.../../............/.....................
.................-.............-.|/..............-.......\...-..|..|........\..../....../...|.................
.........-.................-..........|..........\...................\............./.................-.....\..
....................|........./......|................/.............|................/.\....|............\..|.
..........................\\..../................./.........../-..||......./.............|--....|........\-.-.
.......-.........|..-......-.....\.......................................\-......./.....\.......\/......\.....
............-.......\.............-....||.-.....................\........../..................................
...|........-......\....|.......-.....|.-......\........./.-....-..................../..|..................\..
....\..-.....\.......\.....................-.........\............/.....-.../......-..................\.......
.......-...........\.../..............\..........\..........-................../....-..|....-.......-.........
..../......|...................../\|......-.......-|.........\......|..../||............\........|............
......\.............|...-..................\...|.............-|..-........|................\..................
|./../.............................-..............|.../.....-......|.....\......./........-.......\...........
.............................|...../......\.................\......-.....|..../................./......./.....
..../................-.-..........\....\...........\......\....|\..................|...../|.......-.........\.
.........../.-.....././..|..................................-..........\................/........../|....|....
.||........\.....\.-....\-........................../............................................-..../.......
.../...\.....-\...........\..........|.\...|\..............|........|........|..\\.../.|............|.........
.......\..-....../......./..................\...../\.-....................|.......\.......-...................
...-..........\/..........-...|..................|..................-.../.............-..............\\..-./..
....\...|..|...........-.........|.............................\....-....../..\......................../...../
.-../..\..........|....|........../.......-......................\..............-.....................-.......
|................/..-...........-.\...-|......./.......\..-.....|....\......../............\..................
../../-\-....................|...........|...|..................-...|...........\.......\.....\.........-/....
......................................-...-................/.....|..-../..\................|./...../.../......
....................../.........\......|.\.../......................\...\.....-....................|..........
.........|.-.......\/...../-......|....-.....-.-...........|..........................|....--.........|.......
........................................-............./....-........|........|||-.....\....................\..
...............|\.............\\..-.....|....................\.....-........................\.....|.......|...
.......|..............................................................................................\.\/\...
.................|..../..................../.......\............|....................|.-........|....\.|......
|...............-.................................\........\...........-...................-................|.
.\.........../....||..............................................|......-.....|......................-.|.....
......././.........../...........\.......-...--./|..-......................\............./.....|...|..........
..\...|............|..|.\..........|../.............-...\............|...................................../..
...................|.-..........-..........|..\...../..../....\.//..........|./...............................
./|...../....../..................-\......|.......|.......\.............|....\............./.|..-...-......../
.|....\........\........-....|........../........-.........\..............................................\...
.....-|..........|....-..................-............................/.|..........\.............../......../.
.........................\.........|.......|./.../.......\........-........................\..-\.../..........
.....\....-\..............-......................-....\..................-............................/.......
.............|...|.............-...\.....|..\................\-..............|.......\........................
.....|............|./..\......................./..../............../......../.......................|-....-...
....|....|.......\..|...../......................................\......................-....|..............|.
.\..../.....-.../.........../................/..\....\............./......\....\............../...............
/|../...................--.......\....../..-./....-.......................\..../|.............\...|..../......
.....-.........-...........-.........|.........................../.............|...-.....-......|.............
............./.......-..../.....|....|............\./....\/.................................../...............
....\.........\................|...-.....-.......................................\........|........../........
............................-...........|...|......../..-......\\...../....................|.....|.........-..
..\./.....-...|-...........\....-....................................\.............-..........\...............
.................|.\/.-....../............-...\.............\..../.\...\........|............-./............./
..\..............|..-\.|.............../...............-\..|../.........................\.....................
....-..........././............/......-........-..........-.....-\................../.........................
....-......\...|......./.................-.........................../.../..../\.......|............./........
...|...\........\............................\..........\|..\.-..................../...........|..-\...|.../..
./.............|.................../..|..|..............|............|.............-...../.|..................
................/....\.........|...................|.....-/..../..\\........\........./....|....-..../.....\..
|..............\......\............................................/......||............|/....\..........|.-..
.............|...........|..........|..............\............\...\.........|...............................
...../....../\....................../............./.................\.-.......|../-...........................
\....................|....|...|.\/............-|...|.........................|.................../../.........
...........\|..|..-...........-...............................-\|............./..................\..........|.
.........-./....\........\.............-........-.|....................|......................../\............
..|...............\......-.........................................................\...././...................
/...|...........-....\.................................\./.......|...../...../.|........-.-.................|.
/..........\......../......|........|......................................../................\....|.......\.\
\..\....-..........//.........................\.....\....................................................\....
......../.............-........................|........................../\.................|................
.........................................|................./.....-.........-......|//.-........//........-..|.
......../.\.../............./........|\.....-..\./...........................-....-........|.\|/............\.
.\.../.....|...../.|.....................-................|..................../..-...\....\..............|...
/.............|./...../..-.........\.|..............|.......|.....|..../...|...\..................-./.........
..........|..............\................\....../.-../..-....|.....|.........-...............................
.............../............|........................../......./.\.....................-...|./.......-.....\..
.................../.......|.|...........\./-./\||.|....|........-...........\......-....-..........-.........`
